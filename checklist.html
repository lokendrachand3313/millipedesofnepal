<main>
    <div class="search-container" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <select id="orderFilter" class="filter-select"><option value="all">Select Order</option></select>
        <select id="familyFilter" class="filter-select"><option value="all">Select Family</option></select>
        <select id="genusFilter" class="filter-select"><option value="all">Select Genus</option></select>
        <select id="speciesFilter" class="filter-select"><option value="all">Select Species</option></select>
    </div>

    <div id="resultsCount" style="text-align: center; margin-bottom: 20px; font-weight: bold;"></div>
    
    <div id="checklistResults">
        <div style="text-align:center; color:#666;">Select a species to view full details.</div>
    </div>
</main>

<style>
    .filter-select {
        padding: 10px;
        border-radius: 8px;
        border: 2px solid var(--primary-green);
        min-width: 150px;
        cursor: pointer;
    }
</style>

<script>
    let speciesData = [];

    // Load Data
    fetch('checklist.json')
        .then(response => response.json())
        .then(data => {
            speciesData = data;
            initFilters();
        });

    function initFilters() {
        populateDropdown('orderFilter', 'order');
        setupListeners();
    }

    function populateDropdown(id, key, filterKey = null, filterValue = null) {
        const select = document.getElementById(id);
        select.innerHTML = `<option value="all">Select ${key.charAt(0).toUpperCase() + key.slice(1)}</option>`;
        
        let filtered = speciesData;
        if (filterKey && filterValue !== 'all') {
            filtered = speciesData.filter(item => item[filterKey] === filterValue);
        }

        const uniqueVals = [...new Set(filtered.map(item => item[key]))].sort();
        uniqueVals.forEach(val => {
            if(val) {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                select.appendChild(opt);
            }
        });
    }

    function setupListeners() {
        const orderSel = document.getElementById('orderFilter');
        const familySel = document.getElementById('familyFilter');
        const genusSel = document.getElementById('genusFilter');
        const speciesSel = document.getElementById('speciesFilter');

        orderSel.onchange = () => {
            populateDropdown('familyFilter', 'family', 'order', orderSel.value);
            familySel.onchange(); // Trigger cascade
        };

        familySel.onchange = () => {
            populateDropdown('genusFilter', 'genus', 'family', familySel.value);
            genusSel.onchange(); // Trigger cascade
        };

        genusSel.onchange = () => {
            populateDropdown('speciesFilter', 'species', 'genus', genusSel.value);
            updateResults();
        };

        speciesSel.onchange = updateResults;
    }

    function updateResults() {
        const order = document.getElementById('orderFilter').value;
        const family = document.getElementById('familyFilter').value;
        const genus = document.getElementById('genusFilter').value;
        const species = document.getElementById('speciesFilter').value;

        const filtered = speciesData.filter(item => 
            (order === 'all' || item.order === order) &&
            (family === 'all' || item.family === family) &&
            (genus === 'all' || item.genus === genus) &&
            (species === 'all' || item.species === species)
        );

        displayResults(filtered);
    }

    function displayResults(results) {
        const container = document.getElementById('checklistResults');
        const count = document.getElementById('resultsCount');
        count.innerText = `Showing ${results.length} species`;
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = '<p style="text-align:center;">No species found matching those criteria.</p>';
            return;
        }

        results.forEach(item => {
            const card = document.createElement('div');
            card.className = 'species-card';
            card.innerHTML = `
                <div class="taxa-path">${item.order} > ${item.family}</div>
                <div class="species-name"><i>${item.genus} ${item.species}</i> ${item.author || ''}</div>
                <p><span class="detail-label">Type Locality:</span> ${item.type_locality || 'N/A'}</p>
                <p><span class="detail-label">Global Distribution:</span> ${item.global_dist || 'N/A'}</p>
                <p><span class="detail-label">Nepal Distribution:</span> ${item.nepal_dist || 'N/A'}</p>
            `;
            container.appendChild(card);
        });
    }
</script>
