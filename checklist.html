<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepal Millipede Species Checklist with Map</title>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --primary-green: #2e7d32;
            --light-bg: #f5f5f5;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
        }

        h1 {
            color: var(--primary-green);
            text-align: center;
            margin-bottom: 30px;
        }

        .search-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .filter-select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--primary-green);
            min-width: 150px;
            cursor: pointer;
            background: white;
            font-size: 14px;
        }

        .filter-select:hover {
            border-color: #1b5e20;
        }

        .filter-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        .clear-filters-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: var(--primary-green);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .clear-filters-btn:hover {
            background: #1b5e20;
        }

        #resultsCount {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--primary-green);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            border: 2px solid var(--primary-green);
            position: sticky;
            top: 20px;
        }

        .results-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .species-card {
            background: var(--light-bg);
            border-left: 4px solid var(--primary-green);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .species-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-left-width: 6px;
        }

        .species-card.active {
            background: #e8f5e9;
            border-left-color: #1b5e20;
            border-left-width: 6px;
        }

        .taxa-path {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .species-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1b5e20;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .species-name i {
            font-style: italic;
        }

        .detail-label {
            font-weight: bold;
            color: var(--primary-green);
            display: inline-block;
            min-width: 120px;
        }

        .detail-row {
            margin: 8px 0;
            line-height: 1.4;
        }

        .coordinates-badge {
            background: #fff;
            border: 1px solid var(--primary-green);
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.85em;
            color: var(--primary-green);
            display: inline-block;
            margin-top: 10px;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .leaflet-popup-content {
            font-family: inherit;
            min-width: 200px;
        }

        .leaflet-popup-content strong {
            color: var(--primary-green);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 400px;
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <h1>ðŸ¦Ÿ Nepal Millipede Species Checklist</h1>
    
    <div class="search-container">
        <select id="orderFilter" class="filter-select">
            <option value="all">Select Order</option>
        </select>
        <select id="familyFilter" class="filter-select">
            <option value="all">Select Family</option>
        </select>
        <select id="genusFilter" class="filter-select">
            <option value="all">Select Genus</option>
        </select>
        <select id="speciesFilter" class="filter-select">
            <option value="all">Select Species</option>
        </select>
        <button class="clear-filters-btn" onclick="clearAllFilters()">Clear Filters</button>
    </div>

    <div id="resultsCount">Loading species data...</div>
    
    <div class="main-content">
        <div class="results-container" id="checklistResults">
            <!-- Results will be populated here -->
        </div>
        
        <div id="map"></div>
    </div>

    <script>
    // GPS Data for millipede points (from your dataset)
    const millipedePoints = [
        // Glomerida - Glomeridae
        { order: "Glomerida", family: "Glomeridae", genus: "Hyleoglomeris", species: "crassipes", lat: 27.20386, lon: 87.464502 },
        { order: "Glomerida", family: "Glomeridae", genus: "Hyleoglomeris", species: "gorkhalis", lat: 28.045647, lon: 84.631087 },
        { order: "Glomerida", family: "Glomeridae", genus: "Hyleoglomeris", species: "gorkhalis", lat: 27.98539, lon: 84.630633 },
        { order: "Glomerida", family: "Glomeridae", genus: "Hyleoglomeris", species: "khumbua", lat: 27.83277, lon: 86.746399 },
        { order: "Glomerida", family: "Glomeridae", genus: "Hyleoglomeris", species: "khumbua", lat: 27.901691, lon: 86.894647 },
        { order: "Glomerida", family: "Glomeridae", genus: "Hyleoglomeris", species: "nagarjunga", lat: 27.744675, lon: 85.268067 },
        { order: "Glomerida", family: "Glomeridae", genus: "Hyleoglomeris", species: "tinjurana", lat: 27.199902, lon: 87.46934 },
        
        // Sphaerotheriida - Zephroniidae
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Kophosphaera", species: "excavata", lat: 27.656439, lon: 85.180041 },
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Kophosphaera", species: "martensi", lat: 28.313552, lon: 83.839932 },
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Kophosphaera", species: "politissima", lat: 27.657703, lon: 87.910006 },
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Kophosphaera", species: "politissima", lat: 27.611755, lon: 87.875046 },
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Kophosphaera", species: "shivapuri", lat: 27.80925, lon: 85.387725 },
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Zephronia", species: "nepalensis", lat: 27.010641, lon: 87.925383 },
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Zephronia", species: "nepalensis", lat: 27.090529, lon: 87.913849 },
        { order: "Sphaerotheriida", family: "Zephroniidae", genus: "Zephronia", species: "nepalensis", lat: 27.124438, lon: 87.904898 },
        
        // Add more points from your dataset here...
        // (I've included a sample, but you should include ALL your points)
    ];

    // Full species data from checklist.json
    let speciesData = [];
    let map = null;
    let markers = [];
    let currentActiveCard = null;

    // Initialize map
    function initMap() {
        map = L.map('map').setView([28.3949, 84.1240], 7); // Center on Nepal
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
    }

    // Clear all markers from map
    function clearMarkers() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
    }

    // Add markers for selected species
    function addMarkersForSpecies(order, family, genus, species) {
        clearMarkers();
        
        const filteredPoints = millipedePoints.filter(point => 
            (order === 'all' || point.order === order) &&
            (family === 'all' || point.family === family) &&
            (genus === 'all' || point.genus === genus) &&
            (species === 'all' || point.species === species)
        );

        if (filteredPoints.length === 0) {
            return;
        }

        // Create bounds to fit all markers
        const bounds = [];
        
        filteredPoints.forEach(point => {
            if (point.lat && point.lon) {
                const marker = L.marker([point.lat, point.lon]).addTo(map);
                
                // Create popup with species info
                const popupContent = `
                    <strong>${point.genus} ${point.species}</strong><br>
                    <em>${point.family}</em><br>
                    <small>Lat: ${point.lat.toFixed(4)}<br>Lon: ${point.lon.toFixed(4)}</small>
                `;
                
                marker.bindPopup(popupContent);
                
                marker.on('click', () => {
                    // Highlight corresponding card if it exists
                    const cardId = `${point.genus}_${point.species}`.replace(/\s+/g, '-');
                    const card = document.getElementById(cardId);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        if (currentActiveCard) {
                            currentActiveCard.classList.remove('active');
                        }
                        card.classList.add('active');
                        currentActiveCard = card;
                    }
                });
                
                markers.push(marker);
                bounds.push([point.lat, point.lon]);
            }
        });

        // Fit map to show all markers
        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // Load Data
    fetch('checklist.json')
        .then(response => response.json())
        .then(data => {
            speciesData = data;
            initFilters();
            initMap();
            document.getElementById('resultsCount').innerText = `Total: ${speciesData.length} species`;
            displayResults(speciesData); // Show all initially
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('checklistResults').innerHTML = 
                '<div class="no-data">Error loading species data. Please try again.</div>';
            initMap(); // Still initialize map
        });

    function initFilters() {
        populateDropdown('orderFilter', 'order');
        setupListeners();
    }

    function populateDropdown(id, key, filterKey = null, filterValue = null) {
        const select = document.getElementById(id);
        const currentValue = select.value;
        
        let filtered = speciesData;
        if (filterKey && filterValue && filterValue !== 'all') {
            filtered = speciesData.filter(item => item[filterKey] === filterValue);
        }

        const uniqueVals = [...new Set(filtered.map(item => item[key]))]
            .filter(val => val && val !== 'null' && val !== 'undefined')
            .sort();

        select.innerHTML = `<option value="all">Select ${key.charAt(0).toUpperCase() + key.slice(1)}</option>`;
        
        uniqueVals.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            select.appendChild(opt);
        });

        // Restore previous selection if it exists in new options
        if (currentValue && currentValue !== 'all' && uniqueVals.includes(currentValue)) {
            select.value = currentValue;
        }
    }

    function setupListeners() {
        const orderSel = document.getElementById('orderFilter');
        const familySel = document.getElementById('familyFilter');
        const genusSel = document.getElementById('genusFilter');
        const speciesSel = document.getElementById('speciesFilter');

        orderSel.onchange = () => {
            familySel.innerHTML = '<option value="all">Select Family</option>';
            genusSel.innerHTML = '<option value="all">Select Genus</option>';
            speciesSel.innerHTML = '<option value="all">Select Species</option>';
            
            if (orderSel.value !== 'all') {
                populateDropdown('familyFilter', 'family', 'order', orderSel.value);
            }
            updateResults();
        };

        familySel.onchange = () => {
            genusSel.innerHTML = '<option value="all">Select Genus</option>';
            speciesSel.innerHTML = '<option value="all">Select Species</option>';
            
            if (familySel.value !== 'all') {
                populateDropdown('genusFilter', 'genus', 'family', familySel.value);
            }
            updateResults();
        };

        genusSel.onchange = () => {
            speciesSel.innerHTML = '<option value="all">Select Species</option>';
            
            if (genusSel.value !== 'all') {
                populateDropdown('speciesFilter', 'species', 'genus', genusSel.value);
            }
            updateResults();
        };

        speciesSel.onchange = updateResults;
    }

    function updateResults() {
        const order = document.getElementById('orderFilter').value;
        const family = document.getElementById('familyFilter').value;
        const genus = document.getElementById('genusFilter').value;
        const species = document.getElementById('speciesFilter').value;

        const filtered = speciesData.filter(item => 
            (order === 'all' || item.order === order) &&
            (family === 'all' || item.family === family) &&
            (genus === 'all' || item.genus === genus) &&
            (species === 'all' || item.species === species)
        );

        displayResults(filtered);
        
        // Update map with filtered species points
        addMarkersForSpecies(order, family, genus, species);
        
        // Update filter status text
        const filterStatus = [];
        if (order !== 'all') filterStatus.push(order);
        if (family !== 'all') filterStatus.push(family);
        if (genus !== 'all') filterStatus.push(genus);
        if (species !== 'all') filterStatus.push(species);
        
        const statusText = filterStatus.length > 0 
            ? `Showing ${filtered.length} species matching: ${filterStatus.join(' > ')}`
            : `Showing all ${filtered.length} species`;
            
        document.getElementById('resultsCount').innerText = statusText;
    }

    function displayResults(results) {
        const container = document.getElementById('checklistResults');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = '<div class="no-data">No species found matching those criteria.</div>';
            return;
        }

        results.forEach(item => {
            // Find GPS points for this species
            const speciesPoints = millipedePoints.filter(p => 
                p.order === item.order && 
                p.family === item.family && 
                p.genus === item.genus && 
                p.species === item.species
            ).filter(p => p.lat && p.lon);

            const hasCoordinates = speciesPoints.length > 0;
            const cardId = `${item.genus}_${item.species}`.replace(/\s+/g, '-');

            const card = document.createElement('div');
            card.className = 'species-card';
            card.id = cardId;
            
            // Create coordinates display
            let coordsHtml = '';
            if (hasCoordinates) {
                coordsHtml = `<div class="coordinates-badge">ðŸ“ ${speciesPoints.length} location${speciesPoints.length > 1 ? 's' : ''} on map</div>`;
            }

            card.innerHTML = `
                <div class="taxa-path">${item.order || 'N/A'} > ${item.family || 'N/A'}</div>
                <div class="species-name"><i>${item.genus || '?'} ${item.species || '?'}</i> ${item.author || ''}</div>
                <div class="detail-row"><span class="detail-label">Type Locality:</span> ${item.type_locality || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Global Distribution:</span> ${item.global_dist || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Nepal Distribution:</span> ${item.nepal_dist || 'N/A'}</div>
                ${coordsHtml}
            `;

            // Add click handler to show on map
            card.onclick = () => {
                if (hasCoordinates) {
                    // Clear previous active state
                    if (currentActiveCard) {
                        currentActiveCard.classList.remove('active');
                    }
                    card.classList.add('active');
                    currentActiveCard = card;
                    
                    // Show these points on map
                    clearMarkers();
                    
                    speciesPoints.forEach(point => {
                        const marker = L.marker([point.lat, point.lon]).addTo(map);
                        marker.bindPopup(`
                            <strong>${point.genus} ${point.species}</strong><br>
                            <em>${point.family}</em><br>
                            <small>Lat: ${point.lat.toFixed(4)}<br>Lon: ${point.lon.toFixed(4)}</small>
                        `);
                        markers.push(marker);
                    });
                    
                    // Fit map to show all points for this species
                    if (speciesPoints.length > 0) {
                        const bounds = speciesPoints.map(p => [p.lat, p.lon]);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            };

            container.appendChild(card);
        });
    }

    function clearAllFilters() {
        document.getElementById('orderFilter').value = 'all';
        document.getElementById('familyFilter').innerHTML = '<option value="all">Select Family</option>';
        document.getElementById('genusFilter').innerHTML = '<option value="all">Select Genus</option>';
        document.getElementById('speciesFilter').innerHTML = '<option value="all">Select Species</option>';
        
        // Repopulate family based on 'all' orders
        populateDropdown('familyFilter', 'family');
        
        updateResults();
    }

    // Make clearAllFilters available globally
    window.clearAllFilters = clearAllFilters;
    </script>
</body>
</html>
