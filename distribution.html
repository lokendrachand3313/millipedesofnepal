<main>
    <div class="controls">
        <div class="filter-group">
            <label>Filter by Order</label>
            <select id="orderFilter" onchange="filterFamily()"><option value="all">All Orders</option></select>
        </div>
        <div class="filter-group">
            <label>Filter by Family</label>
            <select id="familyFilter" onchange="filterGenus()"><option value="all">All Families</option></select>
        </div>
        <div class="filter-group">
            <label>Filter by Genus</label>
            <select id="genusFilter" onchange="filterSpecies()"><option value="all">All Genera</option></select>
        </div>
        <div class="filter-group">
            <label>Filter by Species</label>
            <select id="speciesFilter" onchange="updateMap()"><option value="all">All Species</option></select>
        </div>
    </div>

    <div id="map" style="height: 600px;"></div>
</main>

<script>
    // 1. Function to fill dropdowns with unique values from your 194 species
    function fillDropdown(elementId, key, filterKey = null, filterValue = null) {
        const select = document.getElementById(elementId);
        select.innerHTML = `<option value="all">All ${key.charAt(0).toUpperCase() + key.slice(1)}s</option>`;
        
        // Get unique values based on current filters
        let filteredData = millipedePoints;
        if (filterKey && filterValue !== 'all') {
            filteredData = millipedePoints.filter(p => p[filterKey] === filterValue);
        }

        const uniqueValues = [...new Set(filteredData.map(p => p[key]))].sort();
        
        uniqueValues.forEach(val => {
            if (val) {
                let opt = document.createElement('option');
                opt.value = val;
                opt.innerHTML = val;
                select.appendChild(opt);
            }
        });
    }

    // 2. Cascading logic: When Order changes, update Family, then Genus, then Species
    function filterFamily() {
        const val = document.getElementById('orderFilter').value;
        fillDropdown('familyFilter', 'family', 'order', val);
        fillDropdown('genusFilter', 'genus', 'order', val);
        fillDropdown('speciesFilter', 'species', 'order', val);
        updateMap();
    }

    function filterGenus() {
        const val = document.getElementById('familyFilter').value;
        fillDropdown('genusFilter', 'genus', 'family', val);
        fillDropdown('speciesFilter', 'species', 'family', val);
        updateMap();
    }

    function filterSpecies() {
        const val = document.getElementById('genusFilter').value;
        fillDropdown('speciesFilter', 'species', 'genus', val);
        updateMap();
    }

    // 3. Update the Map Markers
    function updateMap() {
        markers.clearLayers();
        const filters = {
            order: document.getElementById('orderFilter').value,
            family: document.getElementById('familyFilter').value,
            genus: document.getElementById('genusFilter').value,
            species: document.getElementById('speciesFilter').value
        };

        millipedePoints.forEach(p => {
            const match = (filters.order === 'all' || p.order === filters.order) &&
                          (filters.family === 'all' || p.family === filters.family) &&
                          (filters.genus === 'all' || p.genus === filters.genus) &&
                          (filters.species === 'all' || p.species === filters.species);

            if (match) {
                const marker = L.marker([p.lat, p.lon]).bindPopup(`
                    <div style="line-height:1.5">
                        <b style="color:#2d5a27; font-size:16px;">${p.genus} ${p.species}</b><br>
                        <hr>
                        <b>Order:</b> ${p.order}<br>
                        <b>Family:</b> ${p.family}<br>
                        <b>Coordinates:</b> ${p.lat}, ${p.lon}
                    </div>
                `);
                markers.addLayer(marker);
            }
        });
    }

    // Initial load: Fill the Order list and show all points
    fillDropdown('orderFilter', 'order');
    updateMap();
</script>
